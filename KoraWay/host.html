<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>KoraWay — Host Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--green:#1B6B3A;--green2:#145230;--green3:#0a2e18;--gold:#F0A500;--dark:#1A1A1A;--ivory:#FAF6EF;--white:#fff;--muted:#6B7280;--border:#E5E0D8;--purple:#7C3AED;--red:#EF4444}
html,body{height:100%;font-family:'Plus Jakarta Sans',sans-serif;background:var(--ivory);color:var(--dark);overflow:hidden}
body{display:flex;flex-direction:column}
.topbar{height:52px;background:var(--green3);display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;flex-shrink:0}
.topbar-logo{font-weight:800;font-size:1rem;color:var(--gold);text-decoration:none;display:flex;align-items:center;gap:.5rem}
.topbar-badge{font-size:.58rem;background:rgba(240,165,0,.2);color:var(--gold);border-radius:4px;padding:.1rem .4rem;font-weight:600}
.topbar-right{display:flex;align-items:center;gap:1rem}
.topbar-back{color:rgba(255,255,255,.45);font-size:.79rem;text-decoration:none;font-weight:500}
.host-pill{background:rgba(74,222,128,.12);border:1px solid rgba(74,222,128,.25);color:#4ADE80;border-radius:6px;padding:.25rem .75rem;font-size:.72rem;font-weight:700}
.app-body{flex:1;display:grid;grid-template-columns:230px 1fr;overflow:hidden}
.sidebar{background:var(--green3);display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,.06);overflow-y:auto}
.sidebar-user{padding:1.25rem;border-bottom:1px solid rgba(255,255,255,.07)}
.su-photo{width:48px;height:48px;border-radius:50%;background:var(--green);color:#fff;font-size:1rem;font-weight:700;display:flex;align-items:center;justify-content:center;margin-bottom:.65rem;overflow:hidden;flex-shrink:0}
.su-photo img{width:100%;height:100%;object-fit:cover}
.su-name{color:#fff;font-size:.9rem;font-weight:700}
.su-role{color:rgba(255,255,255,.4);font-size:.72rem;margin-top:.1rem}
.su-pill{display:inline-flex;align-items:center;gap:.3rem;margin-top:.45rem;background:rgba(74,222,128,.1);border:1px solid rgba(74,222,128,.2);color:#4ADE80;border-radius:4px;padding:.15rem .5rem;font-size:.67rem;font-weight:700}
.sidebar-nav{padding:.75rem 0;flex:1}
.s-section{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,.22);padding:.5rem 1.25rem .3rem}
.s-item{display:flex;align-items:center;gap:.7rem;padding:.65rem 1.25rem;color:rgba(255,255,255,.48);font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;border-left:2px solid transparent;text-decoration:none}
.s-item:hover{color:rgba(255,255,255,.82);background:rgba(255,255,255,.04)}
.s-item.active{color:#fff;background:rgba(255,255,255,.07);border-left-color:var(--gold)}
.s-item svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0}
.s-badge{background:var(--gold);color:var(--dark);border-radius:99px;font-size:.6rem;font-weight:700;padding:.1rem .42rem;margin-left:auto;min-width:16px;text-align:center}
.sidebar-footer{padding:1rem 1.25rem;border-top:1px solid rgba(255,255,255,.06)}
.s-logout{display:flex;align-items:center;gap:.6rem;color:rgba(255,255,255,.28);font-size:.78rem;font-weight:600;cursor:pointer;transition:color .2s;background:none;border:none;font-family:inherit;width:100%;padding:0}
.s-logout:hover{color:rgba(255,255,255,.6)}
.s-logout svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.main{display:flex;flex-direction:column;overflow:hidden}
.main-topbar{height:48px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;flex-shrink:0;background:var(--white)}
.main-title{font-size:.9rem;font-weight:700}
.main-content{flex:1;overflow-y:auto;padding:1.5rem}
.btn{border:none;border-radius:7px;font-family:inherit;font-weight:600;cursor:pointer;transition:all .2s}
.btn-sm{padding:.38rem .85rem;font-size:.77rem}
.btn-md{padding:.6rem 1.2rem;font-size:.84rem;font-weight:700}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{background:var(--green2)}
.btn-gold{background:var(--gold);color:var(--dark)}.btn-gold:hover{background:#d99200}
.btn-ghost{background:transparent;color:var(--muted);border:1.5px solid var(--border)}.btn-ghost:hover{border-color:var(--green);color:var(--green)}
.btn-outline{background:transparent;color:var(--green);border:1.5px solid var(--green)}
.btn-red{background:transparent;color:var(--red);border:1.5px solid #fca5a5}.btn-red:hover{background:#fef2f2}
.banner{background:var(--green3);border-radius:14px;padding:1.25rem 1.5rem;display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem}
.banner h2{color:#fff;font-size:1.05rem;font-weight:700;margin-bottom:.2rem}
.banner p{color:rgba(255,255,255,.48);font-size:.79rem}
.banner-badge{background:rgba(74,222,128,.1);border:1px solid rgba(74,222,128,.2);border-radius:8px;padding:.32rem .8rem;color:#4ADE80;font-size:.74rem;font-weight:700;white-space:nowrap}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:.85rem;margin-bottom:1.25rem}
.stat-c{background:var(--white);border-radius:12px;border:1px solid var(--border);padding:1rem}
.stat-c-val{font-family:'Playfair Display',serif;font-size:1.7rem;color:var(--green);line-height:1;margin-bottom:.2rem}
.stat-c-lbl{font-size:.78rem;font-weight:700;margin-bottom:.1rem}
.stat-c-sub{font-size:.7rem;color:var(--muted)}
.content-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem;margin-top:1.4rem}
.content-hdr h3{font-size:.9rem;font-weight:700}
.tag{border-radius:4px;padding:.18rem .52rem;font-size:.7rem;font-weight:600;display:inline-block}
.tag-ivory{background:var(--ivory);color:var(--dark)}
.tag-green{background:#EEF7F1;color:var(--green)}
.tag-gold{background:#FEF6E4;color:#7a4f00}
.tag-purple{background:#F5F0FF;color:var(--purple)}
.ai-lbl{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--green);margin-bottom:.4rem;display:flex;align-items:center;gap:.4rem}
.ai-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pd .8s ease-in-out infinite alternate;flex-shrink:0}
@keyframes pd{from{opacity:.3}to{opacity:1}}
.s-card{background:var(--white);border-radius:14px;border:1px solid var(--border);overflow:hidden;margin-bottom:.85rem;transition:border-color .2s}
.s-card:hover{border-color:rgba(240,165,0,.4)}
.s-card.request-card{border-color:rgba(240,165,0,.5);box-shadow:0 2px 16px rgba(240,165,0,.1)}
.s-card-top{padding:1rem 1.1rem;display:flex;align-items:flex-start;gap:.9rem}
.s-avatar{width:42px;height:42px;border-radius:50%;background:var(--gold);color:var(--dark);font-weight:700;font-size:.88rem;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.s-info{flex:1;min-width:0}
.s-name{font-size:.9rem;font-weight:700;margin-bottom:.15rem}
.s-meta{font-size:.74rem;color:var(--muted);margin-bottom:.45rem}
.s-tags{display:flex;flex-wrap:wrap;gap:.25rem}
.s-status{padding:.22rem .65rem;border-radius:5px;font-size:.7rem;font-weight:700;white-space:nowrap;flex-shrink:0}
.status-active{background:#EEF7F1;color:var(--green)}
.status-available{background:#F5F0FF;color:var(--purple)}
.status-request{background:#FEF6E4;color:#9a6800}
.request-banner{background:linear-gradient(135deg,rgba(240,165,0,.12),rgba(240,165,0,.05));border-top:1px solid rgba(240,165,0,.25);padding:.9rem 1.1rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
.request-banner-text strong{display:block;font-size:.84rem;font-weight:700;margin-bottom:.15rem}
.request-banner-text p{font-size:.76rem;color:var(--muted);line-height:1.5}
.request-actions{display:flex;gap:.5rem;flex-shrink:0}
.plan-panel{border-top:1px solid var(--border);background:var(--ivory)}
.plan-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--white);padding:0 1.1rem}
.plan-tab{padding:.55rem .9rem;font-size:.78rem;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;background:none;border-top:none;border-left:none;border-right:none;font-family:inherit}
.plan-tab.active{color:var(--green);border-bottom-color:var(--green)}
.plan-content{padding:1rem 1.1rem}
.plan-week{margin-bottom:.85rem}
.plan-week-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;cursor:pointer;padding:.4rem .5rem;border-radius:7px;transition:background .2s}
.plan-week-hdr:hover{background:rgba(0,0,0,.03)}
.plan-week-title{font-size:.81rem;font-weight:700;display:flex;align-items:center;gap:.5rem}
.plan-week-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.plan-task{display:flex;align-items:flex-start;gap:.6rem;margin-bottom:.4rem;padding:.6rem .7rem;background:var(--white);border-radius:8px;border:1px solid var(--border)}
.plan-check{width:17px;height:17px;border-radius:4px;border:1.5px solid var(--border);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.6rem;transition:all .2s;margin-top:.15rem}
.plan-check.done{background:var(--green);border-color:var(--green);color:#fff}
.plan-task-body{flex:1;min-width:0}
.plan-task-text{font-size:.81rem;line-height:1.5}
.plan-task-text.done{text-decoration:line-through;color:var(--muted)}
.plan-task-meta{display:flex;align-items:center;gap:.35rem;margin-top:.2rem;flex-wrap:wrap}
.plan-comments{margin-top:.4rem;display:flex;flex-direction:column;gap:.3rem}
.comment-bubble{border-radius:6px;padding:.3rem .6rem;font-size:.74rem;line-height:1.5}
.comment-bubble.host{background:#EEF7F1;border-left:2px solid var(--green)}
.comment-bubble.student{background:#F5F0FF;border-left:2px solid var(--purple)}
.comment-who{font-size:.63rem;font-weight:700;color:var(--muted);margin-bottom:.1rem}
.comment-input-row{display:flex;gap:.4rem;margin-top:.4rem}
.comment-input{flex:1;border:1.5px solid var(--border);border-radius:6px;padding:.32rem .58rem;font-family:inherit;font-size:.76rem;outline:none}
.comment-btn{background:var(--green);color:#fff;border:none;border-radius:6px;padding:.32rem .65rem;font-family:inherit;font-size:.72rem;font-weight:600;cursor:pointer}
.chat-wrap{display:flex;flex-direction:column;height:320px;background:var(--white)}
.chat-body{flex:1;overflow-y:auto;padding:.85rem;display:flex;flex-direction:column;gap:.5rem}
.chat-bubble-wrap{display:flex;gap:.4rem;align-items:flex-end}
.chat-bubble-wrap.me{flex-direction:row-reverse}
.chat-av{width:24px;height:24px;border-radius:50%;background:var(--gold);color:var(--dark);font-size:.58rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.chat-av.host-av{background:var(--green);color:#fff}
.chat-bubble{max-width:78%;padding:.5rem .75rem;border-radius:10px;font-size:.8rem;line-height:1.5}
.chat-bubble.them{background:var(--ivory);border-radius:2px 10px 10px 10px}
.chat-bubble.me{background:var(--green);color:#fff;border-radius:10px 10px 2px 10px}
.chat-time{font-size:.62rem;color:var(--muted);padding:0 .5rem;margin-bottom:.15rem}
.chat-input-row{padding:.6rem .85rem;border-top:1px solid var(--border);display:flex;gap:.5rem;background:var(--white)}
.chat-input{flex:1;border:1.5px solid var(--border);border-radius:8px;padding:.48rem .72rem;font-family:inherit;font-size:.82rem;outline:none}
.chat-send{background:var(--green);color:#fff;border:none;border-radius:8px;padding:.48rem .9rem;font-family:inherit;font-size:.76rem;font-weight:600;cursor:pointer}
.generating-overlay{position:fixed;inset:0;background:rgba(10,46,24,.88);z-index:999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.generating-overlay.hidden{display:none}
.generating-box{background:var(--green3);border:1px solid rgba(240,165,0,.25);border-radius:16px;padding:2.5rem;max-width:380px;width:100%;text-align:center}
.gen-pulse{width:60px;height:60px;border-radius:50%;background:rgba(240,165,0,.12);border:2px solid rgba(240,165,0,.3);display:flex;align-items:center;justify-content:center;margin:0 auto 1.25rem;position:relative}
.gen-pulse::before{content:'';position:absolute;inset:-10px;border-radius:50%;border:2px solid rgba(240,165,0,.12);animation:gp 1.6s ease-out infinite}
@keyframes gp{0%{transform:scale(1);opacity:1}100%{transform:scale(1.5);opacity:0}}
.gen-pulse svg{width:24px;height:24px;stroke:var(--gold);fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.gen-title{color:#fff;font-family:'Playfair Display',serif;font-size:1.2rem;margin-bottom:.4rem}
.gen-sub{color:rgba(255,255,255,.48);font-size:.8rem;margin-bottom:1.5rem;line-height:1.6}
.gen-steps{display:flex;flex-direction:column;gap:.4rem}
.gen-step{display:flex;align-items:center;gap:.65rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:8px;padding:.55rem .8rem;transition:all .3s}
.gen-step.active{background:rgba(240,165,0,.08);border-color:rgba(240,165,0,.25)}
.gen-step.done{background:rgba(27,107,58,.15);border-color:rgba(27,107,58,.3)}
.gen-step-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.2);flex-shrink:0;transition:background .3s}
.gen-step.active .gen-step-dot{background:var(--gold)}
.gen-step.done .gen-step-dot{background:#4ADE80}
.gen-step-lbl{font-size:.76rem;color:rgba(255,255,255,.4);font-weight:600;transition:color .3s}
.gen-step.active .gen-step-lbl{color:rgba(255,255,255,.9)}
.gen-step.done .gen-step-lbl{color:rgba(255,255,255,.45)}
.impact-hero{display:grid;grid-template-columns:repeat(4,1fr);gap:.85rem;margin-bottom:1.25rem}
.impact-tile{background:var(--white);border-radius:12px;border:1px solid var(--border);padding:1rem;text-align:center}
.impact-tile-val{font-family:'Playfair Display',serif;font-size:1.9rem;color:var(--green);line-height:1;margin-bottom:.2rem}
.impact-tile-lbl{font-size:.75rem;font-weight:700;color:var(--muted)}
.profile-hero-card{background:var(--green3);border-radius:16px;padding:2rem;margin-bottom:1.25rem;display:flex;gap:1.5rem;align-items:flex-start}
.profile-photo-wrap{position:relative;flex-shrink:0}
.profile-photo{width:72px;height:72px;border-radius:50%;background:var(--green);color:#fff;font-size:1.4rem;font-weight:700;display:flex;align-items:center;justify-content:center;overflow:hidden;border:2.5px solid rgba(255,255,255,.15)}
.profile-photo img{width:100%;height:100%;object-fit:cover}
.profile-photo-btn{position:absolute;bottom:0;right:0;width:22px;height:22px;border-radius:50%;background:var(--gold);color:var(--dark);border:none;cursor:pointer;font-size:.65rem;display:flex;align-items:center;justify-content:center;font-weight:700}
.profile-hero-info h2{color:#fff;font-size:1.1rem;font-weight:700;margin-bottom:.2rem}
.profile-hero-info p{color:rgba(255,255,255,.48);font-size:.79rem;margin-bottom:.6rem}
.profile-pills{display:flex;flex-wrap:wrap;gap:.35rem}
.profile-pill{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:5px;padding:.18rem .6rem;font-size:.7rem;font-weight:600;color:rgba(255,255,255,.75)}
.info-card{background:var(--white);border-radius:14px;border:1px solid var(--border);overflow:hidden;margin-bottom:1rem}
.info-card-hdr{padding:.7rem 1.1rem;border-bottom:1px solid var(--border);font-size:.74rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:.65rem 1.1rem;border-bottom:1px solid var(--border);font-size:.83rem}
.info-row:last-child{border-bottom:none}
.info-row .lbl{color:var(--muted);font-weight:500}
.info-row .val{font-weight:600;text-align:right;max-width:62%}
.modal-overlay{position:fixed;inset:0;background:rgba(10,46,24,.75);z-index:900;display:flex;align-items:center;justify-content:center;padding:1.5rem;backdrop-filter:blur(4px)}
.modal-overlay.hidden{display:none}
.modal-box{background:var(--white);border-radius:16px;width:100%;max-width:480px;max-height:85vh;overflow-y:auto}
.modal-hdr{padding:1.1rem 1.4rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--white)}
.modal-hdr h3{font-size:.95rem;font-weight:700}
.modal-close{background:none;border:none;cursor:pointer;color:var(--muted);font-size:1.1rem;padding:.2rem}
.modal-body{padding:1.4rem}
.login-screen{display:grid;grid-template-columns:1fr 1fr;height:100%;overflow:hidden}
.login-screen.hidden{display:none}
.login-left{background:var(--green3);padding:3rem;display:flex;flex-direction:column;justify-content:space-between}
.login-brand{font-family:'Playfair Display',serif;font-size:2rem;color:#fff;margin-bottom:.35rem}
.login-sub-lbl{color:rgba(255,255,255,.4);font-size:.84rem;margin-bottom:2rem}
.login-chips{display:flex;flex-direction:column;gap:.7rem;margin-bottom:auto}
.login-chip{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:.8rem 1rem}
.login-chip strong{display:block;color:#4ADE80;font-size:.78rem;margin-bottom:.15rem}
.login-chip span{color:rgba(255,255,255,.5);font-size:.75rem;line-height:1.5}
.login-quote{border-left:2px solid var(--gold);padding-left:1rem;margin-top:2rem}
.login-quote p{font-family:'Playfair Display',serif;font-size:.92rem;font-style:italic;color:rgba(255,255,255,.72);line-height:1.6;margin-bottom:.3rem}
.login-quote span{color:rgba(255,255,255,.3);font-size:.72rem}
.login-right{padding:2.5rem 2rem;display:flex;flex-direction:column;justify-content:center;background:var(--white);overflow-y:auto}
.login-right h2{font-size:1.25rem;font-weight:800;margin-bottom:.25rem}
.login-right > p{color:var(--muted);font-size:.82rem;margin-bottom:1.4rem}
.field{margin-bottom:.75rem}
.field label{display:block;font-size:.67rem;font-weight:700;color:var(--muted);margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.05em}
.field input{width:100%;padding:.56rem .8rem;border:1.5px solid var(--border);border-radius:8px;font-family:inherit;font-size:.86rem;color:var(--dark);background:var(--white);outline:none;transition:border-color .2s}
.field input:focus{border-color:var(--green)}
.login-err{background:#FEF0EC;border:1px solid #F5C6B8;color:#C94B1F;border-radius:7px;padding:.55rem .8rem;font-size:.76rem;font-weight:600;margin-bottom:.65rem;display:none}
.login-err.show{display:block}
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(12px);background:var(--dark);color:#fff;padding:.55rem 1.15rem;border-radius:7px;font-size:.78rem;font-weight:600;opacity:0;transition:all .3s;z-index:9999;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
@keyframes mfade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:768px){body{overflow:auto}.app-body{grid-template-columns:1fr}.sidebar{display:none}.login-screen{grid-template-columns:1fr}.login-left{display:none}.stats-row,.impact-hero{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="topbar">
  <a class="topbar-logo" href="index.html">KoraWay <span class="topbar-badge">Boston</span></a>
  <div class="topbar-right"><span class="host-pill">Host Dashboard</span><a class="topbar-back" href="index.html">Back to site</a></div>
</div>

<div class="generating-overlay hidden" id="gen-overlay">
  <div class="generating-box">
    <div class="gen-pulse"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div>
    <div class="gen-title" id="gen-title">Building arrival plan</div>
    <div class="gen-sub" id="gen-sub">AI is reading the student profile</div>
    <div class="gen-steps" id="gen-steps"></div>
  </div>
</div>

<div class="modal-overlay hidden" id="profile-modal">
  <div class="modal-box">
    <div class="modal-hdr"><h3 id="profile-modal-title">Student Profile</h3><button class="modal-close" onclick="closeModal('profile-modal')">&#x2715;</button></div>
    <div class="modal-body" id="profile-modal-body"></div>
  </div>
</div>

<div class="modal-overlay hidden" id="msg-modal">
  <div class="modal-box" style="max-width:440px">
    <div class="modal-hdr"><h3 id="msg-modal-title">Send Message</h3><button class="modal-close" onclick="closeModal('msg-modal')">&#x2715;</button></div>
    <div class="modal-body">
      <p style="font-size:.82rem;color:var(--muted);margin-bottom:.85rem">Send an introductory message. They will see it when they log in.</p>
      <textarea id="msg-modal-text" style="width:100%;height:100px;border:1.5px solid var(--border);border-radius:8px;padding:.65rem .8rem;font-family:inherit;font-size:.84rem;outline:none;resize:none"></textarea>
      <div style="display:flex;gap:.5rem;margin-top:.85rem">
        <button class="btn btn-green btn-md" style="flex:1" onclick="sendAvailableMessage()">Send Message</button>
        <button class="btn btn-ghost btn-md" onclick="closeModal('msg-modal')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="app-body" id="app-body" style="display:none">
  <div class="sidebar">
    <div class="sidebar-user">
      <div class="su-photo" id="sb-photo"></div>
      <div class="su-name" id="sb-name"></div>
      <div class="su-role">Host Family &middot; Boston</div>
      <div class="su-pill">&#9733; Vetted Host</div>
    </div>
    <div class="sidebar-nav">
      <div class="s-section">Main</div>
      <a class="s-item active" id="sn-dashboard" onclick="showPage('dashboard')">
        <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Dashboard
      </a>
      <a class="s-item" id="sn-students" onclick="showPage('students')">
        <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>My Students
        <span class="s-badge" id="req-badge" style="display:none">!</span>
      </a>
      <a class="s-item" id="sn-ask" onclick="showPage('ask')">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Ask AI
      </a>
      <a class="s-item" id="sn-impact" onclick="showPage('impact')">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12l2 2 4-4"/></svg>My Activity
      </a>
      <a class="s-item" id="sn-profile" onclick="showPage('profile')">
        <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>My Profile
      </a>
    </div>
    <div class="sidebar-footer">
      <button class="s-logout" onclick="doLogout()">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign Out
      </button>
    </div>
  </div>
  <div class="main">
    <div class="main-topbar"><div class="main-title" id="main-title">Dashboard</div></div>
    <div class="main-content">
      <div id="page-dashboard"></div>
      <div id="page-students" style="display:none"></div>
      <div id="page-impact"   style="display:none"></div>
      <div id="page-ask"      style="display:none"></div>
      <div id="page-profile"  style="display:none"></div>

    </div>
  </div>
</div>

<div class="login-screen" id="screen-login">
  <div class="login-left">
    <div>
      <div class="login-brand">KoraWay</div>
      <div class="login-sub-lbl">Host Family Dashboard &middot; Boston Pilot</div>
      <div class="login-chips">
        <div class="login-chip"><strong>Accept Student Requests</strong><span>Review student profiles then accept to trigger an AI-generated arrival plan</span></div>
        <div class="login-chip"><strong>AI Arrival Plans</strong><span>4-week plan based on each student's needs. Both sides can comment.</span></div>
        <div class="login-chip"><strong>My Activity</strong><span>Track hours, sessions, and student progress across your hosting history</span></div>
      </div>
    </div>
    <div class="login-quote"><p>"A prepared host makes all the difference in those first two weeks."</p><span>KoraWay host onboarding</span></div>
  </div>
  <div class="login-right">
    <h2>Host Sign In</h2>
    <p>Boston pilot &middot; Host family accounts</p>
    <button class="btn btn-gold btn-md" style="width:100%;margin-bottom:1rem" onclick="startHostDemo()">&#9654; Start Host Demo</button>
    <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem"><div style="flex:1;height:1px;background:var(--border)"></div><span style="font-size:.72rem;color:var(--muted)">or sign in manually</span><div style="flex:1;height:1px;background:var(--border)"></div></div>
    <div class="login-err" id="login-err">Invalid email or password.</div>
    <div class="field"><label>Email</label><input type="email" id="l-email" placeholder="oumar@example.com" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <div class="field"><label>Password</label><input type="password" id="l-pw" placeholder="demo123" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <p style="font-size:.73rem;color:var(--muted);margin-bottom:.75rem">Demo: <strong>oumar@example.com</strong> / demo123</p>
    <button class="btn btn-green btn-md" style="width:100%" onclick="doLogin()">Sign In as Host</button>
    <p style="font-size:.72rem;color:var(--muted);margin-top:1rem;text-align:center">Student? <a href="app.html" style="color:var(--green);font-weight:600">Student app</a></p>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
var WEEK_COLORS = ['#22C55E','#F0A500','#7C3AED','#3B82F6'];
var CAT_TAGS    = {Housing:'tag-gold',Banking:'tag-green',Academic:'tag-purple',Culture:'tag-gold',Language:'tag-green',Social:'tag-ivory'};
var SESSION_TYPES = [
  {name:'Welcome dinner',hours:2},{name:'Banking setup',hours:2},{name:'Campus tour',hours:3},
  {name:'Cultural orientation',hours:2},{name:'Housing walkthrough',hours:1.5},
  {name:'Academic briefing',hours:1.5},{name:'Grocery run',hours:1},
  {name:'Transit orientation',hours:1},{name:'Community intro',hours:2}
];
var _msgTargetEmail = null;

var users        = JSON.parse(localStorage.getItem('kw_users')         || '[]');
var hostRequests = JSON.parse(localStorage.getItem('kw_requests')      || '{}');
var accepted     = JSON.parse(localStorage.getItem('kw_accepted')      || '{}');
var declined     = JSON.parse(localStorage.getItem('kw_declined')      || '{}');
var plans        = JSON.parse(localStorage.getItem('kw_plans')         || '{}');
var planChecks   = JSON.parse(localStorage.getItem('kw_plan_checks')   || '{}');
var planComments = JSON.parse(localStorage.getItem('kw_plan_comments') || '{}');
var actLog       = JSON.parse(localStorage.getItem('kw_act_log')       || '{}');
var hostProfiles = JSON.parse(localStorage.getItem('kw_host_profiles') || '{}');
var chatMsgs     = JSON.parse(localStorage.getItem('kw_chat_msgs')     || '{}');
var currentUser  = JSON.parse(localStorage.getItem('kw_current')       || 'null');

if (!users.length) {
  users = [
    {type:'Student',first_name:'Aminata',last_name:'Diallo',email:'aminata@example.com',password:'demo123',city:'Boston',needs:['Housing','Banking','Culture'],language:'French',arrival_period:'Summer Break',country:'Senegal',school:'Northeastern University',bio:'First-generation student from Dakar. Passionate about public health. Arriving Boston August 2025.'},
    {type:'Student',first_name:'Ibrahima',last_name:'Coulibaly',email:'ibrahima@example.com',password:'demo123',city:'Boston',needs:['Academic','Language','Banking'],language:'Bambara',arrival_period:'Weekdays',country:'Mali',school:'Boston University',bio:'Engineering student from Bamako. First time in the US. Needs help navigating academic systems.'},
    {type:'Host Family',first_name:'Oumar',last_name:'Ndiaye',email:'oumar@example.com',password:'demo123',city:'Boston',availability:['Summer Break','Holidays'],support_areas:['Banking','Academic','Culture','Housing'],languages_spoken:['French','Wolof','English'],home_details:'Senegalese family, Roxbury — 10 min from Harvard, 2 private rooms, home-cooked meals',rating:4.9},
    {type:'Host Family',first_name:'Marie',last_name:'Fontaine',email:'marie@example.com',password:'demo123',city:'Boston',availability:['Summer Break','Weekends'],support_areas:['Housing','Culture','Banking'],languages_spoken:['French','English'],home_details:'Mission Hill, Boston — 5 min walk from Northeastern, 1 spare room, transit-friendly',rating:4.7},
    {type:'Host Family',first_name:'Samba',last_name:'Traore',email:'samba@example.com',password:'demo123',city:'Boston',availability:['Weekdays','Weekends','Summer Break'],support_areas:['Banking','Language','Academic','Culture'],languages_spoken:['French','Bambara','English'],home_details:'Malian family, Dorchester, Boston — near UMass Boston, 1 spare room, fluent Bambara and French',rating:4.8}
  ];
  localStorage.setItem('kw_users', JSON.stringify(users));
}
if (!Object.keys(hostRequests).length && !Object.keys(accepted).length && !Object.keys(declined).length) {
  hostRequests['aminata@example.com'] = 'oumar@example.com';
  localStorage.setItem('kw_requests', JSON.stringify(hostRequests));
}
if (!hostProfiles['oumar@example.com']) {
  hostProfiles['oumar@example.com'] = {bio:'Senegalese-born Boston resident of 12 years. Former banker. Fluent in French, Wolof, and English.',location:'Roxbury, Boston MA',universities:['Harvard University','Boston University','Northeastern University'],photo:null};
  hostProfiles['marie@example.com']  = {bio:'French-speaking host near Northeastern. Hosted 4 students over 3 years.',location:'Mission Hill, Boston MA',universities:['Northeastern University'],photo:null};
  hostProfiles['samba@example.com']  = {bio:'Malian family in Roxbury. Fluent Bambara and French.',location:'Roxbury, Boston MA',universities:['UMass Boston','Boston University'],photo:null};
  localStorage.setItem('kw_host_profiles', JSON.stringify(hostProfiles));
}

function save() {
  localStorage.setItem('kw_users',         JSON.stringify(users));
  localStorage.setItem('kw_requests',      JSON.stringify(hostRequests));
  localStorage.setItem('kw_accepted',      JSON.stringify(accepted));
  localStorage.setItem('kw_declined',      JSON.stringify(declined));
  localStorage.setItem('kw_plans',         JSON.stringify(plans));
  localStorage.setItem('kw_plan_checks',   JSON.stringify(planChecks));
  localStorage.setItem('kw_plan_comments', JSON.stringify(planComments));
  localStorage.setItem('kw_act_log',       JSON.stringify(actLog));
  localStorage.setItem('kw_host_profiles', JSON.stringify(hostProfiles));
  localStorage.setItem('kw_chat_msgs',     JSON.stringify(chatMsgs));
}

function gi(u) { return (u.first_name[0] + (u.last_name ? u.last_name[0] : '')).toUpperCase(); }
function showToast(m) { var t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(function(){ t.classList.remove('show'); }, 2600); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function getRequestedStudents() { return users.filter(function(u){ return u.type==='Student' && hostRequests[u.email]===currentUser.email && !accepted[u.email]; }); }
function getAcceptedStudents()  { return users.filter(function(u){ return u.type==='Student' && accepted[u.email]===currentUser.email; }); }
function getDeclinedStudents()  { return users.filter(function(u){ return u.type==='Student' && declined[u.email]===currentUser.email && !accepted[u.email]; }); }
function getAvailableStudents() { return users.filter(function(u){ return u.type==='Student' && !hostRequests[u.email] && !accepted[u.email] && !declined[u.email]; }); }
function findUser(email) { for(var i=0;i<users.length;i++){ if(users[i].email===email) return users[i]; } return null; }

function startHostDemo() {
  var keys = Object.keys(localStorage);
  for (var i = 0; i < keys.length; i++) { if (keys[i].startsWith('kw_')) localStorage.removeItem(keys[i]); }
  localStorage.setItem('kw_demo_autostart', 'host');
  location.reload();
}

function doLogin() {
  var email = document.getElementById('l-email').value.trim().toLowerCase();
  var pw    = document.getElementById('l-pw').value.trim();
  var user  = findUser(email);
  var errEl = document.getElementById('login-err');
  if (!user || user.password !== pw || user.type !== 'Host Family') { errEl.classList.add('show'); return; }
  errEl.classList.remove('show');
  currentUser = user;
  localStorage.setItem('kw_current', JSON.stringify(user));
  launchApp();
}
function doLogout() { currentUser=null; localStorage.removeItem('kw_current'); location.reload(); }

function launchApp() {
  document.getElementById('screen-login').style.display = 'none';
  document.getElementById('app-body').style.display = 'grid';
  var prof = hostProfiles[currentUser.email] || {};
  var sbp  = document.getElementById('sb-photo');
  sbp.innerHTML = prof.photo ? '<img src="' + prof.photo + '" alt=""/>' : gi(currentUser);
  document.getElementById('sb-name').textContent = currentUser.first_name + ' ' + currentUser.last_name;
  updateBadge();
  _lastCommentSnapshot = (localStorage.getItem('kw_plan_comments') || '{}') + (localStorage.getItem('kw_chat_msgs') || '{}');
  startHostPolling();
  showPage('dashboard');
}

function updateBadge() {
  var reqs  = getRequestedStudents();
  var badge = document.getElementById('req-badge');
  if (reqs.length) { badge.style.display=''; badge.textContent=reqs.length; } else { badge.style.display='none'; }
}

var _hostPollInterval = null;
var _lastCommentSnapshot = '';

function startHostPolling() {
  if (_hostPollInterval) return;
  _hostPollInterval = setInterval(function() {
    if (!currentUser) return;
    // Poll for new student comments and chat messages
    var freshComments = localStorage.getItem('kw_plan_comments') || '{}';
    var freshChats    = localStorage.getItem('kw_chat_msgs')     || '{}';
    var snapshot = freshComments + freshChats;
    if (snapshot !== _lastCommentSnapshot) {
      _lastCommentSnapshot = snapshot;
      planComments = JSON.parse(freshComments);
      chatMsgs     = JSON.parse(freshChats);
      // Re-render whichever page is currently visible
      if (document.getElementById('page-dashboard').style.display !== 'none') renderDashboard();
      if (document.getElementById('page-students').style.display  !== 'none') renderStudents();
    }
  }, 3000);
}

function stopHostPolling() {
  if (_hostPollInterval) { clearInterval(_hostPollInterval); _hostPollInterval = null; }
}

function seedActivityLog(studentName) {
  if (!actLog[currentUser.email] || actLog[currentUser.email].length === 0) {
    actLog[currentUser.email] = [
      {name:'Student accepted & onboarding file created',       hours:0.5, student:studentName, done:true,  date:new Date().toISOString().split('T')[0]},
      {name:'Admin setup — profile, plan, and intro message',   hours:0.5, student:studentName, done:true,  date:new Date().toISOString().split('T')[0]},
      {name:'Welcome dinner + intro',                           hours:2,   student:studentName, done:false, date:null},
      {name:'Banking setup session',                            hours:2,   student:studentName, done:false, date:null},
      {name:'Cultural orientation',                             hours:2,   student:studentName, done:false, date:null},
      {name:'Campus + neighborhood tour',                       hours:3,   student:studentName, done:false, date:null}
    ];
    save();
  }
}

function showPage(p) {
  ['dashboard','students','impact','ask','profile'].forEach(function(pg) {
    document.getElementById('page-'+pg).style.display='none';
    var sn=document.getElementById('sn-'+pg); if(sn) sn.classList.remove('active');
  });
  document.getElementById('page-'+p).style.display='block';
  var sn=document.getElementById('sn-'+p); if(sn) sn.classList.add('active');
  var titles={dashboard:'Dashboard',students:'My Students',impact:'My Activity',ask:'Ask AI',profile:'My Profile'};
  document.getElementById('main-title').textContent = titles[p] || '';
  if (p==='dashboard') renderDashboard();
  if (p==='students')  renderStudents();
  if (p==='impact')    renderImpact();
  if (p==='ask')       renderHostAsk();
  if (p==='profile')   renderProfile();
}

function cleanReply(text) {
  var lines = text.split('\n');
  var html = '';
  var inList = false;
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    if (!line) { if (inList) { html += '</ul>'; inList = false; } html += '<br/>'; continue; }
    if (/^#{1,3}\s+/.test(line)) {
      if (inList) { html += '</ul>'; inList = false; }
      line = line.replace(/^#{1,3}\s+/, '');
      line = line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html += '<div style="font-weight:700;margin:.5rem 0 .2rem;font-size:.83rem">' + line + '</div>';
      continue;
    }
    if (/^[-•*]\s+/.test(line)) {
      if (!inList) { html += '<ul style="margin:.35rem 0 .35rem 1rem;padding:0">'; inList = true; }
      line = line.replace(/^[-•*]\s+/, '');
      line = line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      line = line.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html += '<li style="margin-bottom:.2rem;font-size:.8rem">' + line + '</li>';
      continue;
    }
    if (inList) { html += '</ul>'; inList = false; }
    line = line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    line = line.replace(/\*(.+?)\*/g, '<em>$1</em>');
    html += '<div style="margin-bottom:.25rem">' + line + '</div>';
  }
  if (inList) html += '</ul>';
  return html;
}

function callClaude(messages, system, max_tokens) {
  return fetch('/api/chat', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({messages:messages, system:system, max_tokens:max_tokens||500})
  }).then(function(r){ return r.json(); }).then(function(d){ return d.text||null; }).catch(function(){ return null; });
}

function acceptStudent(studentEmail) {
  accepted[studentEmail] = currentUser.email;
  delete hostRequests[studentEmail];
  delete declined[studentEmail];
  save(); updateBadge();
  var student = findUser(studentEmail);
  var ckey    = currentUser.email + '_' + studentEmail;
  if (!chatMsgs[ckey]) {
    chatMsgs[ckey] = [{from:'host', text:'Hi ' + student.first_name + '! I have reviewed your profile and I am excited to welcome you. I speak ' + (currentUser.languages_spoken||[]).join(' and ') + ' and I am ready to help.', ts:Date.now()-120000}];
  }
  seedActivityLog(student.first_name + ' ' + student.last_name);
  save();
  showPlanGenerating(student);
}

function declineStudent(studentEmail) {
  delete hostRequests[studentEmail];
  declined[studentEmail] = currentUser.email;
  save(); updateBadge();
  showToast('Request declined — you can still accept from My Students');
  showPage('students');
}

function acceptDeclined(studentEmail) {
  delete declined[studentEmail];
  save();
  acceptStudent(studentEmail);
}

function showPlanGenerating(student) {
  var overlay = document.getElementById('gen-overlay');
  var stepsEl = document.getElementById('gen-steps');
  document.getElementById('gen-title').textContent = 'Building ' + student.first_name + "'s arrival plan";
  document.getElementById('gen-sub').textContent   = 'AI is analysing the student profile and needs';
  var steps = ['Reading student profile','Mapping needs to Boston resources','Building week-by-week tasks','Writing AI coaching notes','Finalising your plan'];
  stepsEl.innerHTML = '';
  for (var i=0; i<steps.length; i++) {
    var d = document.createElement('div');
    d.className='gen-step'; d.id='gstep-'+i;
    d.innerHTML='<div class="gen-step-dot"></div><span class="gen-step-lbl">'+steps[i]+'</span>';
    stepsEl.appendChild(d);
  }
  overlay.classList.remove('hidden');
  var planDone = false;
  generatePlan(currentUser, student).then(function(){ planDone=true; });
  var delays = [0,700,1400,2100,3300,4000];
  for (var j=0; j<steps.length; j++) {
    (function(idx){
      setTimeout(function(){
        var prev=document.getElementById('gstep-'+(idx-1));
        if(prev){prev.classList.remove('active');prev.classList.add('done');}
        var el=document.getElementById('gstep-'+idx);
        if(el) el.classList.add('active');
      }, delays[idx]);
    })(j);
  }
  var checkDone = function() {
    if (planDone) {
      var last=document.getElementById('gstep-'+(steps.length-1));
      if(last){last.classList.remove('active');last.classList.add('done');}
      overlay.classList.add('hidden');
      showToast(student.first_name + ' accepted — 4-week plan ready');
      showPage('dashboard');
    } else {
      setTimeout(checkDone, 300);
    }
  };
  setTimeout(checkDone, delays[steps.length-1]+800);
}

function generatePlan(host, student) {
  var key = host.email+'_'+student.email;
  if (plans[key]) return Promise.resolve(plans[key]);
  var system = 'You are KoraWay AI. Generate a 4-week arrival support plan. Return ONLY valid JSON no markdown: {"weeks":[{"week":1,"theme":"string","tasks":[{"id":"w1t1","text":"string","category":"Housing|Banking|Academic|Culture|Language|Social","hours":1.5,"aiNote":"string"}]}]}. 4 weeks, 3-4 tasks each. Be specific to student country, language, school, and needs.';
  var prompt = 'Host: '+host.first_name+', Boston, speaks '+(host.languages_spoken||[]).join(', ')+'. Student: '+student.first_name+' from '+student.country+', speaks '+student.language+', attending '+(student.school||'a Boston university')+', needs: '+student.needs.join(', ')+', arriving '+student.arrival_period+'. Bio: '+(student.bio||'');
  return callClaude([{role:'user',content:prompt}], system, 900).then(function(result) {
    var parsed = null;
    if (result) { try { parsed=JSON.parse(result.replace(/```json|```/g,'').trim()); } catch(e){} }
    if (!parsed) {
      parsed = {weeks:[
        {week:1,theme:'Arrival & First Steps',tasks:[
          {id:'w1t1',text:'Meet '+student.first_name+' on arrival day and show them the home',category:'Social',hours:2,aiNote:'Start the conversation in '+student.language+' to put them at ease immediately.'},
          {id:'w1t2',text:'Walk the neighbourhood — transit stop, grocery store, pharmacy',category:'Housing',hours:1.5,aiNote:'Point out the nearest MBTA stop and any African or halal grocery stores nearby.'},
          {id:'w1t3',text:'Open a bank account — bring I-20, passport, proof of enrollment',category:'Banking',hours:2,aiNote:'Chase and Bank of America both accept I-20 for international students. Call ahead.'}
        ]},
        {week:2,theme:'Campus and Admin',tasks:[
          {id:'w2t1',text:'Walk the '+(student.school||'university')+' campus together',category:'Academic',hours:2.5,aiNote:'Find the international student services office first.'},
          {id:'w2t2',text:'Get student ID, MBTA semester pass, and set up university email',category:'Academic',hours:1.5,aiNote:'The student MBTA pass saves significantly — apply in the first week.'},
          {id:'w2t3',text:'Introduce '+student.first_name+' to the international student advisor',category:'Academic',hours:1,aiNote:'A warm personal introduction works better than sending them alone.'}
        ]},
        {week:3,theme:'Community and Culture',tasks:[
          {id:'w3t1',text:'Visit a local '+student.country+' or West African community space',category:'Culture',hours:2,aiNote:'The diaspora community in Roxbury and Dorchester is active and welcoming.'},
          {id:'w3t2',text:'Explore Boston by MBTA — practice the route to campus and back',category:'Social',hours:2,aiNote:'Do a practice run so the route becomes automatic before classes start.'},
          {id:'w3t3',text:'Connect '+student.first_name+' with student organisations from '+student.country,category:'Social',hours:1,aiNote:'Most Boston universities have West African student associations.'}
        ]},
        {week:4,theme:'Independence Check-in',tasks:[
          {id:'w4t1',text:'Review all checklist items — any outstanding needs?',category:'Academic',hours:1,aiNote:'Be honest about gaps and make a follow-up plan for anything incomplete.'},
          {id:'w4t2',text:'Confirm '+student.first_name+' can navigate daily life independently',category:'Culture',hours:1.5,aiNote:'Ask them to walk you through their typical week.'},
          {id:'w4t3',text:'Celebrate with a meal from '+student.country,category:'Social',hours:2,aiNote:'This closing moment marks the transition to independent student life.'}
        ]}
      ]};
    }
    plans[key]=parsed; save(); return parsed;
  });
}

function renderDashboard() {
  var u         = currentUser;
  var accepted_ = getAcceptedStudents();
  var requested = getRequestedStudents();
  var acts      = actLog[u.email]||[];
  var sessionHrsDone = 0;
  for(var si=0; si<acts.length; si++){ if(acts[si].done) sessionHrsDone += acts[si].hours||0; }
  var totalHrs  = 0;
  for (var i=0;i<acts.length;i++) { if(acts[i].done) totalHrs+=acts[i].hours||1.5; }

  var planTasksDone = 0, planTasksTotal = 0;
  accepted_.forEach(function(s) {
    var plan = plans[u.email + '_' + s.email];
    if (plan) { plan.weeks.forEach(function(w) { w.tasks.forEach(function(t) { planTasksTotal++; if (planChecks[u.email + '_' + s.email + '_' + t.id]) planTasksDone++; }); }); }
  });

  var html = '<div class="banner"><div><h2>Welcome back, '+u.first_name+'</h2><p>'+accepted_.length+' active student'+(accepted_.length!==1?'s':'')+' &middot; '+requested.length+' pending request'+(requested.length!==1?'s':'')+' &middot; Boston</p></div><div class="banner-badge">&#9733; Vetted Host</div></div>';
  html += '<div class="stats-row">';
  html += '<div class="stat-c"><div class="stat-c-val">'+accepted_.length+'</div><div class="stat-c-lbl">Active Students</div><div class="stat-c-sub">Currently hosting</div></div>';
  html += '<div class="stat-c"><div class="stat-c-val">'+requested.length+'</div><div class="stat-c-lbl">Pending Requests</div><div class="stat-c-sub">Awaiting response</div></div>';
  html += '<div class="stat-c"><div class="stat-c-val">'+planTasksDone+'/'+planTasksTotal+'</div><div class="stat-c-lbl">Plan Progress</div><div class="stat-c-sub">Tasks completed</div></div>';
  html += '<div class="stat-c"><div class="stat-c-val">'+sessionHrsDone.toFixed(1)+'h</div><div class="stat-c-lbl">Session Hours</div><div class="stat-c-sub">Completed sessions</div></div>';
  html += '</div>';
  if (requested.length) { html+='<div class="content-hdr"><h3>Hosting Requests <span class="tag tag-gold">'+requested.length+' new</span></h3></div>'; for(var r=0;r<requested.length;r++) html+=buildRequestCard(requested[r]); }
  if (accepted_.length) { html+='<div class="content-hdr"><h3>Active Students &mdash; AI Arrival Plans</h3></div>'; for(var a=0;a<accepted_.length;a++) html+=buildPlanCard(accepted_[a],u); }
  if (!accepted_.length&&!requested.length) html+='<div style="background:var(--white);border-radius:14px;border:1px solid var(--border);padding:2.5rem;text-align:center;color:var(--muted);font-size:.84rem;margin-top:.5rem">No active students yet. <a href="#" onclick="showPage(\'students\')" style="color:var(--green);font-weight:600">Browse available students</a></div>';
  document.getElementById('page-dashboard').innerHTML = html;
  for (var k=0;k<accepted_.length;k++) {
    (function(s){
      var pk=u.email+'_'+s.email;
      if(plans[pk]){ renderPlan(s,u,plans[pk]); }
      else {
        var area=document.getElementById('plan-body-'+s.email.replace(/[@.]/g,'_'));
        if(area) area.innerHTML='<div style="padding:1.25rem;text-align:center;color:var(--muted);font-size:.82rem;display:flex;align-items:center;justify-content:center;gap:.5rem"><div class="ai-dot"></div>Generating plan&hellip;</div>';
        generatePlan(u,s).then(function(plan){ renderPlan(s,u,plan); });
      }
    })(accepted_[k]);
  }
}

function buildRequestCard(s) {
  var tags=''; for(var i=0;i<s.needs.length;i++) tags+='<span class="tag tag-ivory">'+s.needs[i]+'</span>';
  var bio=s.bio?'<div style="padding:.65rem 1.1rem;font-size:.8rem;color:var(--muted);line-height:1.6;border-top:1px solid var(--border)">'+s.bio+'</div>':'';
  return '<div class="s-card request-card"><div class="s-card-top"><div class="s-avatar">'+gi(s)+'</div><div class="s-info"><div class="s-name">'+s.first_name+' '+s.last_name+'</div><div class="s-meta">'+s.country+' &middot; '+s.language+' &middot; '+(s.school||'Boston university')+' &middot; Arriving '+s.arrival_period+'</div><div class="s-tags">'+tags+'<span class="tag tag-green">'+s.language+'</span></div></div><span class="s-status status-request">Requested you</span></div>'+bio+'<div class="request-banner"><div class="request-banner-text"><strong>'+s.first_name+' wants you as their host family</strong><p>Accepting will generate an AI 4-week arrival plan and open a message thread.</p></div><div class="request-actions"><button class="btn btn-red btn-sm" onclick="declineStudent(\''+s.email+'\')">Decline</button><button class="btn btn-gold btn-sm" onclick="acceptStudent(\''+s.email+'\')">Accept '+s.first_name+'</button></div></div></div>';
}

function buildPlanCard(s,u) {
  var se=s.email.replace(/[@.]/g,'_');
  var ckey=u.email+'_'+s.email;
  var msgs=chatMsgs[ckey]||[];
  var tags=''; for(var i=0;i<s.needs.length;i++) tags+='<span class="tag tag-ivory">'+s.needs[i]+'</span>';
  var msgCount=msgs.length?' ('+msgs.length+')':'';
  return '<div class="s-card"><div class="s-card-top"><div class="s-avatar">'+gi(s)+'</div><div class="s-info"><div class="s-name">'+s.first_name+' '+s.last_name+'</div><div class="s-meta">'+s.country+' &middot; '+s.language+' &middot; '+(s.school||'Boston university')+' &middot; '+s.arrival_period+'</div><div class="s-tags">'+tags+'<span class="tag tag-green">'+s.language+'</span></div></div><span class="s-status status-active">Active</span></div><div class="plan-tabs" id="tabs-'+se+'"><button class="plan-tab active" onclick="switchTab(\''+s.email+'\',\'plan\')">AI Arrival Plan</button><button class="plan-tab" onclick="switchTab(\''+s.email+'\',\'chat\')">Messages'+msgCount+'</button></div><div id="plan-body-'+se+'" class="plan-panel"><div style="padding:1.25rem;text-align:center;color:var(--muted);font-size:.82rem;display:flex;align-items:center;justify-content:center;gap:.5rem"><div class="ai-dot"></div>Loading&hellip;</div></div><div id="chat-body-'+se+'" class="plan-panel" style="display:none">'+buildChatPanel(s,u)+'</div></div>';
}

function switchTab(studentEmail,tab) {
  var se=studentEmail.replace(/[@.]/g,'_');
  var tabsEl=document.getElementById('tabs-'+se); if(!tabsEl) return;
  var tabs=tabsEl.querySelectorAll('.plan-tab');
  tabs[0].classList.toggle('active',tab==='plan'); tabs[1].classList.toggle('active',tab==='chat');
  var pe=document.getElementById('plan-body-'+se); var ce=document.getElementById('chat-body-'+se);
  if(pe) pe.style.display=tab==='plan'?'block':'none';
  if(ce) ce.style.display=tab==='chat'?'block':'none';
  if(tab==='chat'){var cb=document.getElementById('chatbody-'+se);if(cb) cb.scrollTop=cb.scrollHeight;}
}

function renderPlan(student,host,plan) {
  var se=student.email.replace(/[@.]/g,'_');
  var area=document.getElementById('plan-body-'+se); if(!area) return;
  var key=host.email+'_'+student.email;
  var allT=[]; for(var wi=0;wi<plan.weeks.length;wi++) for(var ti=0;ti<plan.weeks[wi].tasks.length;ti++) allT.push(plan.weeks[wi].tasks[ti]);
  var doneCnt=0,totalHrs=0;
  for(var i=0;i<allT.length;i++){totalHrs+=allT[i].hours||1.5;if(planChecks[key+'_'+allT[i].id])doneCnt++;}
  var html='<div class="plan-content"><div class="ai-lbl" style="margin-bottom:.85rem">AI Arrival Plan &middot; '+student.first_name+' &middot; '+doneCnt+'/'+allT.length+' tasks &middot; '+totalHrs+'h total</div>';
  for(var w=0;w<plan.weeks.length;w++){
    var wk=plan.weeks[w]; var wId='pw-'+se+'-'+w; var wDone=0;
    for(var wt=0;wt<wk.tasks.length;wt++) if(planChecks[key+'_'+wk.tasks[wt].id]) wDone++;
    html+='<div class="plan-week"><div class="plan-week-hdr" onclick="toggleWeek(\''+wId+'\')"><div class="plan-week-title"><div class="plan-week-dot" style="background:'+WEEK_COLORS[w%4]+'"></div>Week '+wk.week+' &mdash; '+wk.theme+' <span class="tag tag-ivory" style="font-size:.64rem">'+wDone+'/'+wk.tasks.length+'</span></div><span style="font-size:.68rem;color:var(--muted)">&#9660;</span></div>';
    html+='<div id="'+wId+'" style="display:'+(w===0?'block':'none')+'">';
    for(var t=0;t<wk.tasks.length;t++){
      var task=wk.tasks[t]; var ck=key+'_'+task.id; var ciId='ci-'+ck.replace(/[@.]/g,'_');
      var isDone=planChecks[ck]||false; var comments=planComments[ck]||[];
      html+='<div class="plan-task"><div class="plan-check '+(isDone?'done':'')+'" onclick="toggleTask(\''+ck+'\',\''+student.email+'\',\''+host.email+'\')">'+(isDone?'&#x2713;':'')+'</div><div class="plan-task-body"><div class="plan-task-text '+(isDone?'done':'')+'">' +task.text+'</div><div class="plan-task-meta"><span class="tag '+(CAT_TAGS[task.category]||'tag-ivory')+'" style="font-size:.64rem">'+task.category+'</span><span style="font-size:.67rem;color:var(--muted)">'+(task.hours||1.5)+'h</span></div>';
      if(task.aiNote) html+='<div style="margin-top:.35rem;background:rgba(27,107,58,.06);border-left:2px solid var(--green);border-radius:4px;padding:.28rem .55rem;font-size:.73rem;line-height:1.5"><span style="font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--green)">AI tip &middot; </span>'+task.aiNote+'</div>';
      if(comments.length){html+='<div class="plan-comments">';for(var c=0;c<comments.length;c++){var who=comments[c].role==='host'?host.first_name+' (you)':student.first_name+' (student)';html+='<div class="comment-bubble '+comments[c].role+'"><div class="comment-who">'+who+'</div>'+comments[c].text+'</div>';}html+='</div>';}
      html+='<div class="comment-input-row"><input class="comment-input" id="'+ciId+'" placeholder="Add a note&hellip;"/><button class="comment-btn" onclick="addComment(\''+ck+'\',\''+student.email+'\',\''+host.email+'\')">Send</button></div></div></div>';
    }
    html+='</div></div>';
  }
  html+='</div>'; area.innerHTML=html;
}

function toggleWeek(id){var el=document.getElementById(id);if(el)el.style.display=el.style.display==='none'?'block':'none';}

function toggleTask(ck,studentEmail,hostEmail){
  planChecks[ck]=!planChecks[ck]; save();
  var student=findUser(studentEmail);
  if(student&&plans[hostEmail+'_'+studentEmail]) renderPlan(student,currentUser,plans[hostEmail+'_'+studentEmail]);
  if(document.getElementById('page-impact').style.display!=='none') renderImpact();
}

function addComment(ck,studentEmail,hostEmail){
  var input=document.getElementById('ci-'+ck.replace(/[@.]/g,'_'));
  if(!input||!input.value.trim()) return;
  if(!planComments[ck]) planComments[ck]=[];
  planComments[ck].push({role:'host',text:input.value.trim(),ts:Date.now()});
  save(); input.value='';
  var student=findUser(studentEmail);
  if(student&&plans[hostEmail+'_'+studentEmail]) renderPlan(student,currentUser,plans[hostEmail+'_'+studentEmail]);
  showToast('Note sent to student');
}

function buildChatPanel(student,host){
  var se=student.email.replace(/[@.]/g,'_');
  var ckey=host.email+'_'+student.email; var msgs=chatMsgs[ckey]||[];
  var html=''; for(var i=0;i<msgs.length;i++) html+=buildChatBubble(msgs[i],host,student);
  if(!msgs.length) html='<div style="text-align:center;color:var(--muted);font-size:.79rem;margin:auto">No messages yet.</div>';
  return '<div class="chat-wrap"><div class="chat-body" id="chatbody-'+se+'">'+html+'</div><div class="chat-input-row"><input class="chat-input" id="chatinput-'+se+'" placeholder="Message '+student.first_name+'&hellip;" onkeydown="if(event.key===\'Enter\')sendChat(\''+student.email+'\')"/><button class="chat-send" onclick="sendChat(\''+student.email+'\')">Send</button></div></div>';
}

function buildChatBubble(m,host,student){
  var isMe=m.from==='host';
  var av=isMe?'<div class="chat-av host-av">'+gi(host)+'</div>':'<div class="chat-av">'+gi(student)+'</div>';
  var time=m.ts?new Date(m.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';
  return '<div class="chat-bubble-wrap'+(isMe?' me':'')+'">'+av+'<div><div class="chat-bubble '+(isMe?'me':'them')+'">'+m.text+'</div><div class="chat-time" style="'+(isMe?'text-align:right':'')+'">'+(time)+'</div></div></div>';
}

function sendChat(studentEmail){
  var se=studentEmail.replace(/[@.]/g,'_');
  var input=document.getElementById('chatinput-'+se); if(!input||!input.value.trim()) return;
  var ckey=currentUser.email+'_'+studentEmail;
  if(!chatMsgs[ckey]) chatMsgs[ckey]=[];
  chatMsgs[ckey].push({from:'host',text:input.value.trim(),ts:Date.now()});
  save(); input.value='';
  var student=findUser(studentEmail); var body=document.getElementById('chatbody-'+se);
  if(body&&student){var html='';for(var i=0;i<chatMsgs[ckey].length;i++) html+=buildChatBubble(chatMsgs[ckey][i],currentUser,student);body.innerHTML=html;body.scrollTop=body.scrollHeight;}
}

function renderStudents(){
  var u=currentUser; var accepted_=getAcceptedStudents(); var requested=getRequestedStudents(); var declined_=getDeclinedStudents(); var available=getAvailableStudents();
  var html = '<div class="banner"><div><h2>My Students</h2><p>Pending requests &middot; Active students &middot; Available to host</p></div></div>';

  if(requested.length){
    html+='<div class="content-hdr"><h3>Pending Requests <span class="tag tag-gold">'+requested.length+'</span></h3></div>';
    for(var i=0;i<requested.length;i++) html+=buildRequestCard(requested[i]);
  }
  if(declined_.length){
    html+='<div class="content-hdr"><h3>Previously Declined</h3></div>';
    for(var d=0;d<declined_.length;d++){
      var ds=declined_[d]; var dtags=''; for(var dn=0;dn<ds.needs.length;dn++) dtags+='<span class="tag tag-ivory">'+ds.needs[dn]+'</span>';
      var dbio=ds.bio?'<div style="padding:.65rem 1.1rem;font-size:.8rem;color:var(--muted);line-height:1.6;border-top:1px solid var(--border);background:var(--ivory)">'+ds.bio+'</div>':'';
      html+='<div class="s-card" style="opacity:.85"><div class="s-card-top"><div class="s-avatar" style="background:var(--border);color:var(--muted)">'+gi(ds)+'</div><div class="s-info"><div class="s-name">'+ds.first_name+' '+ds.last_name+'</div><div class="s-meta">'+ds.country+' &middot; '+ds.language+' &middot; '+(ds.school||'Boston university')+' &middot; '+ds.arrival_period+'</div><div class="s-tags">'+dtags+'</div></div><span class="s-status" style="background:#F3EFE8;color:var(--muted)">Declined</span></div>'+dbio+'<div style="padding:.75rem 1.1rem;border-top:1px solid var(--border);display:flex;align-items:center;gap:.75rem"><span style="font-size:.78rem;color:var(--muted);flex:1">Changed your mind?</span><button class="btn btn-gold btn-sm" onclick="acceptDeclined(\''+ds.email+'\')">Accept '+ds.first_name+'</button></div></div>';
    }
  }
  if(accepted_.length){
    html+='<div class="content-hdr"><h3>Currently Hosting ('+accepted_.length+')</h3></div>';
    for(var j=0;j<accepted_.length;j++){
      var s=accepted_[j]; var stags=''; for(var sn=0;sn<s.needs.length;sn++) stags+='<span class="tag tag-ivory">'+s.needs[sn]+'</span>';
      var sbio=s.bio?'<div style="padding:.7rem 1.1rem;border-top:1px solid var(--border);font-size:.8rem;color:var(--muted);line-height:1.6;background:var(--ivory)">'+s.bio+'</div>':'';
      html+='<div class="s-card"><div class="s-card-top"><div class="s-avatar">'+gi(s)+'</div><div class="s-info"><div class="s-name">'+s.first_name+' '+s.last_name+'</div><div class="s-meta">'+s.country+' &middot; Speaks '+s.language+' &middot; '+(s.school||'Boston university')+' &middot; '+s.arrival_period+'</div><div class="s-tags">'+stags+'<span class="tag tag-green">'+s.language+'</span></div></div><span class="s-status status-active">Active</span></div>'+sbio+'<div style="padding:.75rem 1.1rem;border-top:1px solid var(--border);display:flex;gap:.5rem"><button class="btn btn-green btn-sm" onclick="showPage(\'dashboard\')">View Arrival Plan</button><button class="btn btn-ghost btn-sm" onclick="showPage(\'dashboard\');setTimeout(function(){switchTab(\''+s.email+'\',\'chat\');},150)">Message '+s.first_name+'</button></div></div>';
    }
  }
  html += '<div class="content-hdr" style="margin-top:'+(accepted_.length||requested.length||declined_.length?'1.5rem':'0')+'"><h3>Host Another Student</h3></div>';
  html += '<p style="font-size:.79rem;color:var(--muted);margin-bottom:1rem;margin-top:-.3rem">Students looking for a host family in Boston.</p>';
  if(available.length){
    for(var k=0;k<available.length;k++){
      var av=available[k]; var atags=''; for(var an=0;an<av.needs.length;an++) atags+='<span class="tag tag-ivory">'+av.needs[an]+'</span>';
      html+='<div class="s-card"><div class="s-card-top"><div class="s-avatar">'+gi(av)+'</div><div class="s-info"><div class="s-name">'+av.first_name+' '+av.last_name+'</div><div class="s-meta">'+av.country+' &middot; Speaks '+av.language+' &middot; '+(av.school||'Boston university')+' &middot; '+av.arrival_period+'</div><div class="s-tags">'+atags+'</div></div><span class="s-status status-available">Needs host</span></div><div style="padding:.7rem 1.1rem;border-top:1px solid var(--border);display:flex;gap:.5rem"><button class="btn btn-ghost btn-sm" onclick="openProfile(\''+av.email+'\')">View Profile</button><button class="btn btn-green btn-sm" onclick="openMessage(\''+av.email+'\')">Message</button></div></div>';
    }
  } else {
    html+='<div style="background:var(--white);border-radius:14px;border:1px solid var(--border);padding:1.5rem;text-align:center;color:var(--muted);font-size:.83rem">No other students available right now.</div>';
  }
  document.getElementById('page-students').innerHTML=html;
}

function openProfile(email){
  var s=findUser(email); if(!s) return;
  var tags=''; for(var i=0;i<s.needs.length;i++) tags+='<span class="tag tag-ivory">'+s.needs[i]+'</span>';
  var bio=s.bio?'<div style="background:var(--ivory);border-radius:8px;padding:.85rem;font-size:.83rem;line-height:1.7;margin-bottom:1rem">'+s.bio+'</div>':'';
  document.getElementById('profile-modal-title').textContent=s.first_name+' '+s.last_name;
  document.getElementById('profile-modal-body').innerHTML='<div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.25rem;padding-bottom:1.25rem;border-bottom:1px solid var(--border)"><div style="width:52px;height:52px;border-radius:50%;background:var(--gold);color:var(--dark);font-size:1rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">'+gi(s)+'</div><div><div style="font-size:1rem;font-weight:700">'+s.first_name+' '+s.last_name+'</div><div style="font-size:.78rem;color:var(--muted)">'+s.country+' &middot; '+(s.school||'Boston university')+'</div></div></div>'+bio+'<div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:1rem"><div style="background:var(--ivory);border-radius:8px;padding:.7rem"><div style="font-size:.63rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:.2rem">Language</div><div style="font-size:.86rem;font-weight:600">'+s.language+'</div></div><div style="background:var(--ivory);border-radius:8px;padding:.7rem"><div style="font-size:.63rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:.2rem">Arriving</div><div style="font-size:.86rem;font-weight:600">'+s.arrival_period+'</div></div><div style="background:var(--ivory);border-radius:8px;padding:.7rem"><div style="font-size:.63rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:.2rem">School</div><div style="font-size:.86rem;font-weight:600">'+(s.school||'Boston university')+'</div></div><div style="background:var(--ivory);border-radius:8px;padding:.7rem"><div style="font-size:.63rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:.2rem">Country</div><div style="font-size:.86rem;font-weight:600">'+s.country+'</div></div></div><div style="font-size:.69rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-bottom:.4rem">Support Needs</div><div style="display:flex;flex-wrap:wrap;gap:.3rem;margin-bottom:1.25rem">'+tags+'</div><div style="display:flex;gap:.5rem"><button class="btn btn-green btn-sm" onclick="closeModal(\'profile-modal\');openMessage(\''+s.email+'\')">Message '+s.first_name+'</button><button class="btn btn-ghost btn-sm" onclick="closeModal(\'profile-modal\')">Close</button></div>';
  document.getElementById('profile-modal').classList.remove('hidden');
}

function openMessage(email){
  var s=findUser(email); if(!s) return;
  _msgTargetEmail=email;
  document.getElementById('msg-modal-title').textContent='Message '+s.first_name+' '+s.last_name;
  document.getElementById('msg-modal-text').value='Hi '+s.first_name+'! I came across your profile and I think I would be a great host for you in Boston. I speak '+(currentUser.languages_spoken||[]).join(' and ')+' and can help with '+(currentUser.support_areas||[]).slice(0,2).join(' and ')+'. Would love to connect!';
  document.getElementById('msg-modal').classList.remove('hidden');
}

function sendAvailableMessage(){
  var text=document.getElementById('msg-modal-text').value.trim(); if(!text||!_msgTargetEmail) return;
  var ckey=currentUser.email+'_'+_msgTargetEmail;
  if(!chatMsgs[ckey]) chatMsgs[ckey]=[];
  chatMsgs[ckey].push({from:'host',text:text,ts:Date.now()});
  save(); closeModal('msg-modal'); showToast('Message sent');
}

function renderImpact(){
  var u=currentUser; var accepted_=getAcceptedStudents(); var acts=actLog[u.email]||[];
  var done=acts.filter(function(a){return a.done;}); var pending=acts.filter(function(a){return !a.done;});
  var planHrsCompleted = 0;
  var planHrsTotal = 0;
  for(var j=0;j<accepted_.length;j++){
    var p=plans[u.email+'_'+accepted_[j].email];
    if(p){
      for(var w=0;w<p.weeks.length;w++){
        for(var t=0;t<p.weeks[w].tasks.length;t++){
          var th = p.weeks[w].tasks[t].hours||1.5;
          planHrsTotal += th;
          if(planChecks[u.email+'_'+accepted_[j].email+'_'+p.weeks[w].tasks[t].id]) planHrsCompleted += th;
        }
      }
    }
  }
  var planTasksDone=0;
  for(var j=0;j<accepted_.length;j++){var p=plans[u.email+'_'+accepted_[j].email];if(p){for(var w=0;w<p.weeks.length;w++){for(var t=0;t<p.weeks[w].tasks.length;t++){if(planChecks[u.email+'_'+accepted_[j].email+'_'+p.weeks[w].tasks[t].id]) planTasksDone++;}}}}

  var html = '<div class="banner"><div><h2>My Activity</h2><p>Hours Completed &middot; Students Supported &middot; Plan Progress</p></div></div>';
  html+='<div class="impact-hero"><div class="impact-tile"><div class="impact-tile-val">'+accepted_.length+'</div><div class="impact-tile-lbl">Active Students</div></div><div class="impact-tile"><div class="impact-tile-val">'+planHrsCompleted.toFixed(1)+'h / '+planHrsTotal.toFixed(1)+'h</div><div class="impact-tile-lbl">Plan Hours Done</div></div><div class="impact-tile"><div class="impact-tile-val">'+done.length+'</div><div class="impact-tile-lbl">Sessions Done</div></div><div class="impact-tile"><div class="impact-tile-val">'+planTasksDone+'</div><div class="impact-tile-lbl">Plan Tasks Done</div></div></div>';

  if(accepted_.length){
    html+='<div class="content-hdr"><h3>Arrival Plan Progress</h3></div>';
    for(var k=0;k<accepted_.length;k++){
      var st=accepted_[k]; var plan=plans[u.email+'_'+st.email];
      if(!plan){html+='<div style="background:var(--white);border-radius:12px;border:1px solid var(--border);padding:1rem 1.1rem;margin-bottom:.85rem;font-size:.82rem;color:var(--muted)">Plan not yet generated for '+st.first_name+'. <a href="#" onclick="showPage(\'dashboard\')" style="color:var(--green);font-weight:600">Go to dashboard</a></div>';continue;}
      var allT=[]; for(var pw=0;pw<plan.weeks.length;pw++) for(var pt=0;pt<plan.weeks[pw].tasks.length;pt++) allT.push(plan.weeks[pw].tasks[pt]);
      var doneT=0; for(var pi=0;pi<allT.length;pi++) if(planChecks[u.email+'_'+st.email+'_'+allT[pi].id]) doneT++;
      var pct=allT.length?Math.round(doneT/allT.length*100):0;
      var wkb=''; for(var wb=0;wb<plan.weeks.length;wb++){var wbd=0;for(var wbt=0;wbt<plan.weeks[wb].tasks.length;wbt++) if(planChecks[u.email+'_'+st.email+'_'+plan.weeks[wb].tasks[wbt].id]) wbd++;wkb+='<span style="font-size:.73rem;color:var(--muted)">Wk '+plan.weeks[wb].week+' <strong style="color:'+(wbd===plan.weeks[wb].tasks.length?'var(--green)':'var(--dark)')+'">'+wbd+'/'+plan.weeks[wb].tasks.length+'</strong></span>';}
      html+='<div style="background:var(--white);border-radius:12px;border:1px solid var(--border);padding:1.1rem;margin-bottom:.85rem"><div style="display:flex;align-items:center;gap:.85rem;margin-bottom:.75rem"><div class="s-avatar" style="width:36px;height:36px;font-size:.78rem">'+gi(st)+'</div><div style="flex:1"><div style="font-size:.87rem;font-weight:700">'+st.first_name+' '+st.last_name+'</div><div style="font-size:.73rem;color:var(--muted)">'+st.country+' &middot; '+(st.school||'Boston university')+'</div></div><div style="text-align:right"><div style="font-size:.88rem;font-weight:700;color:var(--green)">'+pct+'%</div><div style="font-size:.69rem;color:var(--muted)">'+doneT+'/'+allT.length+' tasks</div></div></div><div style="height:5px;background:var(--border);border-radius:99px;overflow:hidden;margin-bottom:.65rem"><div style="height:100%;width:'+pct+'%;background:var(--green);border-radius:99px;transition:width .4s"></div></div><div style="display:flex;gap:1rem;flex-wrap:wrap">'+wkb+'</div></div>';
    }
  }

  html+='<div class="content-hdr"><h3>Session Log</h3><button class="btn btn-green btn-sm" onclick="logSession()">+ Log Session</button></div>';
  if(pending.length){
    html+='<div style="display:flex;flex-direction:column;gap:.45rem;margin-bottom:1.25rem">';
    for(var pi2=0;pi2<acts.length;pi2++){
      if(!acts[pi2].done){
        html+='<div style="background:var(--white);border:1px solid var(--border);border-radius:10px;padding:.7rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem"><div><div style="font-size:.83rem;font-weight:600">'+acts[pi2].name+'</div><div style="font-size:.71rem;color:var(--muted);margin-top:.1rem">'+acts[pi2].student+' &middot; '+(acts[pi2].hours||1.5)+'h est.</div></div><button class="btn btn-green btn-sm" onclick="markDone('+pi2+')">Mark Done</button></div>';
      }
    }
    html+='</div>';
  } else {
    html+='<div style="background:var(--white);border:1px solid var(--border);border-radius:10px;padding:1.25rem;text-align:center;color:var(--muted);font-size:.82rem;margin-bottom:1.25rem">No upcoming sessions &mdash; click <strong>+ Log Session</strong> to add one.</div>';
  }
  if(done.length){
    html+='<div class="content-hdr"><h3>Completed</h3></div><div style="display:flex;flex-direction:column;gap:.45rem">';
    for(var di=0;di<acts.length;di++){
      if(acts[di].done){
        var undoBtn = acts[di].system ? '<span class="tag tag-green">Done</span>' : '<button class="btn btn-ghost btn-sm" onclick="undoMarkDone('+di+')">Undo</button>';
        html+='<div style="background:var(--white);border:1px solid var(--border);border-radius:10px;padding:.7rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem"><div><div style="font-size:.83rem;font-weight:600">'+acts[di].name+'</div><div style="font-size:.71rem;color:var(--muted);margin-top:.1rem">'+acts[di].student+' &middot; '+(acts[di].hours||0.5)+'h &middot; '+(acts[di].date||'completed')+'</div></div>'+undoBtn+'</div>';
      }
    }
    html+='</div>';
  }
  document.getElementById('page-impact').innerHTML=html;
}

function logSession(){
  var myS=getAcceptedStudents(); var student=myS.length?myS[0].first_name+' '+myS[0].last_name:'General';
  var names=''; for(var i=0;i<SESSION_TYPES.length;i++) names+=(i+1)+'. '+SESSION_TYPES[i].name+' ('+SESSION_TYPES[i].hours+'h)\n';
  var choice=prompt('Choose session type:\n'+names+'\nEnter number:'); if(!choice) return;
  var idx=parseInt(choice)-1; var act=(idx>=0&&idx<SESSION_TYPES.length)?SESSION_TYPES[idx]:{name:choice,hours:1.5};
  if(!actLog[currentUser.email]) actLog[currentUser.email]=[];
  actLog[currentUser.email].push({name:act.name,hours:act.hours,student:student,done:false,date:null});
  save(); showToast('Session added'); renderImpact();
}

function markDone(idx){
  var acts=actLog[currentUser.email]; if(!acts||!acts[idx]) return;
  acts[idx].done=true; acts[idx].date=new Date().toISOString().split('T')[0];
  save(); showToast('Session marked complete'); renderImpact();
}

function undoMarkDone(idx){
  var acts=actLog[currentUser.email]; if(!acts||!acts[idx]) return;
  if(acts[idx].system) { showToast('This item cannot be undone'); return; }
  acts[idx].done=false; acts[idx].date=null;
  save(); showToast('Session moved back to upcoming'); renderImpact();
}

var hostAskHistory = [];

function renderHostAsk() {
  var u = currentUser;
  var myStudents = getAcceptedStudents();
  var student = myStudents[0] || null;
  hostAskHistory = [];

  var suggestedQs = [
    'What should I know about Senegalese cultural norms and etiquette?',
    'How do I help my student open a US bank account as an international student?',
    'What should I prepare for my student\'s first week in Boston?'
  ];
  if (student) {
    suggestedQs[0] = 'What cultural norms from ' + student.country + ' should I be aware of as a host?';
    suggestedQs[1] = 'How do I best support a student who speaks ' + student.language + ' arriving for the first time?';
    suggestedQs[2] = 'What should I prepare specifically for ' + student.first_name + ' based on their needs: ' + (student.needs||[]).join(', ') + '?';
  }

  var intro = student
    ? 'Hi ' + u.first_name + '! I know you are hosting ' + student.first_name + ' from ' + student.country + ' who speaks ' + student.language + ' and needs help with ' + (student.needs||[]).join(', ') + '. Ask me anything about supporting them.'
    : 'Hi ' + u.first_name + '! Ask me anything about hosting West African students in Boston — cultural context, practical preparation, or how to support specific needs.';

  var sugHtml = '';
  for (var i = 0; i < suggestedQs.length; i++) {
    sugHtml += '<button onclick="hostAskSuggested(\'' + suggestedQs[i].replace(/'/g,'') + '\')" style="background:var(--ivory);border:1.5px solid var(--border);border-radius:8px;padding:.5rem .85rem;font-family:inherit;font-size:.77rem;color:var(--dark);cursor:pointer;text-align:left;transition:all .2s;width:100%" onmouseover="this.style.borderColor=\'var(--green)\'" onmouseout="this.style.borderColor=\'var(--border)\'">' + suggestedQs[i] + '</button>';
  }

  document.getElementById('page-ask').innerHTML =
    '<div class="banner"><div><h2>Ask AI</h2><p>Ask anything about hosting and supporting your student</p></div></div>'
    + '<div style="background:var(--white);border-radius:14px;border:1px solid var(--border);display:flex;flex-direction:column;height:calc(100vh - 200px)">'
      + '<div style="padding:1rem 1.1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.75rem">'
        + '<div style="width:34px;height:34px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg></div>'
        + '<div><strong style="display:block;font-size:.88rem;font-weight:700">KoraWay AI</strong><span style="font-size:.73rem;color:var(--muted)">Host advisor &middot; Knows your student</span></div>'
      + '</div>'
      + '<div style="flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.65rem" id="host-ask-body">'
        + '<div style="max-width:82%;padding:.58rem .85rem;border-radius:2px 10px 10px 10px;font-size:.82rem;line-height:1.55;background:var(--ivory);align-self:flex-start">' + intro + '</div>'
        + '<div style="display:flex;flex-direction:column;gap:.4rem;align-self:stretch;margin-top:.25rem">' + sugHtml + '</div>'
      + '</div>'
      + '<div style="padding:.75rem;border-top:1px solid var(--border);display:flex;gap:.6rem">'
        + '<input style="flex:1;border:1.5px solid var(--border);border-radius:8px;padding:.58rem .82rem;font-family:inherit;font-size:.84rem;outline:none" id="host-ask-input" placeholder="Ask anything about hosting your student..." onkeydown="if(event.key===\'Enter\')sendHostAsk()"/>'
        + '<button style="background:var(--green);color:#fff;border:none;border-radius:8px;padding:.58rem 1.1rem;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer" onclick="sendHostAsk()">Ask</button>'
      + '</div>'
    + '</div>';
}

function hostAskSuggested(q) {
  var input = document.getElementById('host-ask-input');
  if (input) { input.value = q; sendHostAsk(); }
}

function sendHostAsk() {
  var input = document.getElementById('host-ask-input');
  var text  = input ? input.value.trim() : ''; if (!text) return;
  input.value = ''; input.disabled = true;
  var body  = document.getElementById('host-ask-body');
  var time  = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  body.innerHTML += '<div style="max-width:82%;padding:.58rem .85rem;border-radius:10px 10px 2px 10px;font-size:.82rem;line-height:1.55;background:var(--green);color:#fff;align-self:flex-end">' + text + '<span style="display:block;font-size:.65rem;color:rgba(255,255,255,.5);margin-top:.25rem">' + time + '</span></div>';
  body.innerHTML += '<div id="host-typing" style="display:flex;gap:.3rem;align-items:center;padding:.55rem .85rem;background:var(--ivory);border-radius:2px 10px 10px 10px;align-self:flex-start;width:fit-content"><div class="td"></div><div class="td"></div><div class="td"></div></div>';
  body.scrollTop = body.scrollHeight;
  hostAskHistory.push({role:'user', content:text});
  var u = currentUser;
  var myStudents = getAcceptedStudents();
  var student = myStudents[0] || null;
  var system = 'You are KoraWay AI advising ' + u.first_name + ', a host family in Boston. They speak ' + (u.languages_spoken||[]).join(', ') + ' and support ' + (u.support_areas||[]).join(', ') + '.'
    + (student ? ' They are hosting ' + student.first_name + ' ' + student.last_name + ' from ' + student.country + ', speaks ' + student.language + ', attending ' + (student.school||'a Boston university') + ', needs: ' + (student.needs||[]).join(', ') + ', arriving ' + student.arrival_period + '. Student bio: ' + (student.bio||'') + '.' : '')
    + ' Always respond in English. Be practical and specific. Use bullet points and bold text to make your answer easy to read. Keep it concise — 3 to 5 bullet points max.';
  callClaude(hostAskHistory, system, 250).then(function(reply) {
    reply = reply || 'Great question. I would recommend checking with the international student office at the student\'s university for the most current guidance.';
    hostAskHistory.push({role:'assistant', content:reply});
    if (hostAskHistory.length > 20) hostAskHistory = hostAskHistory.slice(-20);
    var typing = document.getElementById('host-typing'); if (typing) typing.remove();
    body.innerHTML += '<div style="max-width:82%;padding:.58rem .85rem;border-radius:2px 10px 10px 10px;font-size:.82rem;line-height:1.55;background:var(--ivory);align-self:flex-start">' + cleanReply(reply) + '<span style="display:block;font-size:.65rem;color:var(--muted);margin-top:.25rem">' + time + '</span></div>';
    body.scrollTop = body.scrollHeight;
    input.disabled = false; input.focus();
  });
}

function renderProfile(){
  var u=currentUser; var prof=hostProfiles[u.email]||{};
  var pills=''; var langs=u.languages_spoken||[]; var areas=u.support_areas||[];
  for(var i=0;i<langs.length;i++) pills+='<div class="profile-pill">'+langs[i]+'</div>';
  for(var j=0;j<areas.length;j++) pills+='<div class="profile-pill">'+areas[j]+'</div>';
  pills+='<div class="profile-pill">&#9733; '+(u.rating||4.9)+'</div>';
  var unis=''; var uniArr=prof.universities||[]; for(var k=0;k<uniArr.length;k++) unis+='<span class="tag tag-green">'+uniArr[k]+'</span>';
  var photo=prof.photo?'<img src="'+prof.photo+'" alt=""/>':'<span>'+gi(u)+'</span>';
  document.getElementById('page-profile').innerHTML=
    '<div class="profile-hero-card"><div class="profile-photo-wrap"><div class="profile-photo">'+photo+'</div><button class="profile-photo-btn" onclick="uploadPhoto()">&#x270E;</button></div><div class="profile-hero-info" style="flex:1"><h2>'+u.first_name+' '+u.last_name+'</h2><p>'+(prof.location||'Boston, MA')+' &middot; Host Family</p><div class="profile-pills">'+pills+'</div></div></div>'
   +'<div class="info-card"><div class="info-card-hdr">About Me <button class="btn btn-ghost btn-sm" onclick="editBio()">Edit</button></div><div style="padding:.85rem 1.1rem;font-size:.84rem;line-height:1.7;color:'+(prof.bio?'var(--dark)':'var(--muted)')+'">'+( prof.bio||'Add a short bio&hellip;')+'</div></div>'
   +'<div class="info-card"><div class="info-card-hdr">Profile Details</div><div class="info-row"><span class="lbl">Location</span><span class="val">'+(prof.location||'Boston, MA')+'</span></div><div class="info-row"><span class="lbl">Languages</span><span class="val">'+(langs.join(', ')||'&mdash;')+'</span></div><div class="info-row"><span class="lbl">Availability</span><span class="val">'+((u.availability||[]).join(', ')||'&mdash;')+'</span></div><div class="info-row"><span class="lbl">Areas of Expertise</span><span class="val">'+(areas.join(', ')||'&mdash;')+'</span></div><div class="info-row"><span class="lbl">Home Details</span><span class="val">'+(u.home_details||'&mdash;')+'</span></div><div class="info-row"><span class="lbl">Rating</span><span class="val" style="color:var(--green)">&#9733; '+(u.rating||4.9)+'</span></div></div>'
   +'<div class="info-card"><div class="info-card-hdr">Closest Universities <button class="btn btn-ghost btn-sm" onclick="editUniversities()">Edit</button></div><div style="padding:.85rem 1.1rem;display:flex;flex-wrap:wrap;gap:.35rem">'+(unis||'<span style="font-size:.82rem;color:var(--muted)">None added yet</span>')+'</div></div>'
   +'<div style="display:flex;gap:.7rem;flex-wrap:wrap;margin-top:.5rem"><button class="btn btn-outline btn-md" onclick="doLogout()">Sign Out</button><button class="btn btn-ghost btn-md" onclick="clearDemo()">Reset Demo</button></div>';
}

function editBio() {
  var p = hostProfiles[currentUser.email] || {};
  var current = p.bio || '';
  var el = document.querySelector('#page-profile .info-card div[style*="padding:.85rem"]');
  if (!el) {
    var v = prompt('Edit bio:', current);
    if (v === null) return;
    if (!hostProfiles[currentUser.email]) hostProfiles[currentUser.email] = {};
    hostProfiles[currentUser.email].bio = v.trim();
    save();
    renderProfile();
    return;
  }
  el.innerHTML = '<textarea id="bio-edit" style="width:100%;height:90px;border:1.5px solid var(--green);border-radius:8px;padding:.65rem .8rem;font-family:inherit;font-size:.84rem;outline:none;resize:none">' + current + '</textarea>'
    + '<div style="display:flex;gap:.5rem;margin-top:.5rem"><button class="btn btn-green btn-sm" onclick="saveBio()">Save</button><button class="btn btn-ghost btn-sm" onclick="renderProfile()">Cancel</button></div>';
}

function saveBio() {
  var el = document.getElementById('bio-edit'); if (!el) return;
  if (!hostProfiles[currentUser.email]) hostProfiles[currentUser.email] = {};
  hostProfiles[currentUser.email].bio = el.value.trim();
  save();
  renderProfile();
}

function editUniversities() {
  var p = hostProfiles[currentUser.email] || {};
  var unis = ['Northeastern University','Boston University','Harvard University','MIT','Boston College','UMass Boston','Tufts University'];
  var current = p.universities || [];
  var el = document.querySelector('#page-profile .info-card:last-of-type div[style*="padding:.85rem"]');
  if (!el) return;
  var checkboxes = unis.map(function(u) {
    return '<label style="display:flex;align-items:center;gap:.5rem;font-size:.82rem;cursor:pointer;padding:.2rem 0"><input type="checkbox" value="' + u + '" ' + (current.indexOf(u) > -1 ? 'checked' : '') + '/>' + u + '</label>';
  }).join('');
  el.innerHTML = '<div style="display:flex;flex-direction:column;gap:.1rem;margin-bottom:.6rem">' + checkboxes + '</div>'
    + '<div style="display:flex;gap:.5rem"><button class="btn btn-green btn-sm" onclick="saveUniversities()">Save</button><button class="btn btn-ghost btn-sm" onclick="renderProfile()">Cancel</button></div>';
}

function saveUniversities() {
  var checked = document.querySelectorAll('#page-profile input[type=checkbox]:checked');
  var selected = []; checked.forEach(function(c){ selected.push(c.value); });
  if (!hostProfiles[currentUser.email]) hostProfiles[currentUser.email] = {};
  hostProfiles[currentUser.email].universities = selected;
  save();
  renderProfile();
}

function uploadPhoto(){
  var input=document.createElement('input'); input.type='file'; input.accept='image/*';
  input.onchange=function(e){
    var f=e.target.files[0]; if(!f)return;
    var r=new FileReader();
    r.onload=function(ev){
      if(!hostProfiles[currentUser.email])hostProfiles[currentUser.email]={};
      hostProfiles[currentUser.email].photo=ev.target.result; save();
      var sb=document.getElementById('sb-photo');
      if(sb)sb.innerHTML='<img src="'+ev.target.result+'" alt="" style="width:100%;height:100%;object-fit:cover"/>';
      renderProfile();
    };
    r.readAsDataURL(f);
  };
  input.click();
}

function clearDemo(){
  if(!confirm('Reset all demo data?')) return;
  var keys=Object.keys(localStorage);
  for(var i=0;i<keys.length;i++){if(keys[i].startsWith('kw_')) localStorage.removeItem(keys[i]);}
  location.reload();
}

window.addEventListener('DOMContentLoaded', function() {
  var autostart = localStorage.getItem('kw_demo_autostart');
  if (autostart === 'host') {
    localStorage.removeItem('kw_demo_autostart');
    var fresh = JSON.parse(localStorage.getItem('kw_requests') || '{}');
    if (!fresh['aminata@example.com']) {
      fresh['aminata@example.com'] = 'oumar@example.com';
      localStorage.setItem('kw_requests', JSON.stringify(fresh));
      hostRequests = fresh;
    }
    var oumar = findUser('oumar@example.com');
    if (oumar) { currentUser = oumar; localStorage.setItem('kw_current', JSON.stringify(oumar)); launchApp(); return; }
  }
  if (currentUser && currentUser.type === 'Host Family') launchApp();
});
</script>
</body>
</html>
